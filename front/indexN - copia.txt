<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salud Mental | Malackathon 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #eef4f8; color: #111827; }
    .focus-ring:focus { outline: 2px solid #2563eb; outline-offset: 2px; }
    .card { background: #ffffff; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .accessibility-panel { position: fixed; top: 1rem; right: 1rem; background: #fff; border: 1px solid #cbd5e1; border-radius: .5rem; padding: .5rem; font-size: .85rem; z-index: 50; }
    .accessibility-panel button { display:block; margin:.25rem 0; width:100%; font-size:.8rem; }
    .high-contrast { background-color: #000 !important; color: #ffb300 !important; }
    .high-contrast .card { background-color: #111 !important; color: #ffb300 !important; }
    .high-contrast .focus-ring:focus { outline: 2px solid #ffb300; outline-offset: 2px; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-6">

  <!-- Panel accesibilidad -->
  <div class="accessibility-panel" role="region" aria-label="Opciones de accesibilidad">
    <strong class="block mb-1 text-sky-700">Accesibilidad</strong>
    <button onclick="increaseFont()" class="bg-sky-200 hover:bg-sky-300 rounded px-2 py-1" type="button" aria-label="Aumentar tama√±o de letra">Aumentar letra</button>
    <button onclick="decreaseFont()" class="bg-sky-200 hover:bg-sky-300 rounded px-2 py-1" type="button" aria-label="Reducir tama√±o de letra">Reducir letra</button>
    <button onclick="toggleContrast()" class="bg-sky-200 hover:bg-sky-300 rounded px-2 py-1" type="button" aria-label="Activar o desactivar alto contraste">Alto contraste</button>
    <button onclick="toggleNarrator()" class="bg-sky-200 hover:bg-sky-300 rounded px-2 py-1" type="button" aria-label="Activar o desactivar narrador">Narrador</button>
    <button onclick="showHelp()" class="bg-sky-200 hover:bg-sky-300 rounded px-2 py-1" type="button" aria-label="Mostrar ayuda">Ayuda</button>
  </div>

  <!-- Encabezado -->
  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold text-sky-700 mb-2">üß† Departamento de Salud Mental</h1>
    <p class="text-slate-600 text-lg">Consulta, filtros r√°pidos, detalles y an√°lisis gr√°fico</p>
  </header>

  <!-- Buscador + filtros discretos -->
  <section class="card p-6 w-full max-w-5xl mb-4" role="region" aria-labelledby="search-title">
    <h2 id="search-title" class="text-xl font-semibold text-sky-700 mb-4">üîç Buscar</h2>

    <form id="searchForm" class="mb-3" role="search" aria-label="Formulario de b√∫squeda" onsubmit="return false;">
      <div class="flex gap-2">
        <label for="q" class="sr-only">B√∫squeda libre</label>
        <input id="q" name="q" type="text" placeholder="B√∫squeda libre (ej: Hospital, fecha, nombre...)"
               class="flex-1 p-2 border rounded focus-ring" aria-describedby="search-help" />
        <button id="searchBtn" type="button"
                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded focus-ring">
          Buscar
        </button>
      </div>
      <p id="search-help" class="text-xs text-slate-600 mt-2">
        Puedes introducir m√∫ltiples t√©rminos separados por comas (ej: Andaluc√≠a,Madrid o Infarto,Diabetes).
      </p>
    </form>

    <!-- Filtros discretos multivalor por coma -->
    <div class="flex flex-wrap gap-2 text-xs" role="group" aria-label="Filtros r√°pidos">
      <label for="filtroComunidad" class="sr-only">Filtrar por comunidad</label>
      <input id="filtroComunidad" type="text" inputmode="text"
             class="px-2 py-1 border rounded-full bg-slate-100 focus-ring"
             placeholder="Comunidad (coma)"
             aria-label="Filtrar por comunidad usando comas" />

      <label for="filtroSexo" class="sr-only">Filtrar por sexo</label>
      <input id="filtroSexo" type="text" inputmode="text"
             class="px-2 py-1 border rounded-full bg-slate-100 focus-ring"
             placeholder="Sexo (M,F)"
             aria-label="Filtrar por sexo usando comas" />

      <label for="filtroDiag" class="sr-only">Filtrar por diagn√≥stico principal</label>
      <input id="filtroDiag" type="text" inputmode="text"
             class="px-2 py-1 border rounded-full bg-slate-100 focus-ring"
             placeholder="Diagn√≥stico (coma)"
             aria-label="Filtrar por diagn√≥stico principal usando comas" />

      <label for="filtroServicio" class="sr-only">Filtrar por servicio</label>
      <input id="filtroServicio" type="text" inputmode="text"
             class="px-2 py-1 border rounded-full bg-slate-100 focus-ring"
             placeholder="Servicio (coma)"
             aria-label="Filtrar por servicio usando comas" />
    </div>
    <p class="text-xs text-slate-600 mt-2">
      Escribe varios valores separados por comas para incluirlos (OR). Ej: Neumolog√≠a,Cardiolog√≠a.
    </p>

    <div class="mt-3">
      <button id="resetFiltersBtn" type="button"
              class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded focus-ring">
        Limpiar filtros
      </button>
    </div>
  </section>

  <!-- Resultados -->
  <section id="resultados" class="hidden card p-6 w-full max-w-6xl mb-6" role="region" aria-labelledby="results-title" aria-live="polite">
    <div class="flex justify-between items-center mb-4">
      <h2 id="results-title" class="text-xl font-semibold text-sky-700">üìä Resultados</h2>
      <button id="downloadBtn" type="button"
              class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded focus-ring">
        Descargar CSV
      </button>
    </div>
    <div id="estadisticas" class="text-slate-700 mb-4 text-sm" role="status" aria-live="polite"></div>

    <div id="tabla" class="overflow-x-auto" role="region" aria-label="Tabla de resultados">
      <!-- Tabla se renderiza aqu√≠ -->
    </div>

    <div class="mt-6" role="region" aria-labelledby="chart-title">
      <h3 id="chart-title" class="text-lg font-semibold text-sky-700 mb-2">Distribuci√≥n por diagn√≥stico principal</h3>
      <canvas id="grafica" class="w-full h-64" role="img" aria-label="Gr√°fico de barras por diagn√≥stico principal"></canvas>
    </div>

    <button id="resetBtn" type="button"
            class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded focus-ring">
      Nueva consulta
    </button>
  </section>

  <footer class="mt-6 text-slate-600 text-sm">
    ¬© 2025 <span class="font-bold text-sky-700">Turingos</span> ¬∑ Tu espacio seguro de consulta
  </footer>

<script>
  // Control de accesibilidad
  let fontSize = 100;
  let narratorOn = false;

  function increaseFont() {
    fontSize += 10;
    document.body.style.fontSize = fontSize + "%";
  }
  function decreaseFont() {
    fontSize = Math.max(80, fontSize - 10);
    document.body.style.fontSize = fontSize + "%";
  }
  function toggleContrast() {
    document.body.classList.toggle("high-contrast");
  }
  function toggleNarrator() {
    narratorOn = !narratorOn;
    if (narratorOn) {
      speak("Narrador activado. Los resultados se leer√°n autom√°ticamente.");
    } else {
      speak("Narrador desactivado.");
    }
  }
  function speak(text) {
    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "es-ES";
      window.speechSynthesis.speak(utter);
    }
  }
  function showHelp() {
    alert("Tutorial:\n\n1. Usa el buscador para escribir t√©rminos.\n2. Filtra con los campos discretos bajo el buscador (puedes separar por comas).\n3. Pulsa 'Buscar'.\n4. Ver√°s los resultados en tabla y el gr√°fico.\n5. Usa 'Ver detalles' para ver todos los campos del registro.\n6. Puedes descargar CSV.\n\nAccesibilidad:\n- Aumentar/reducir letra.\n- Alto contraste.\n- Narrador autom√°tico.");
  }
  // Narraci√≥n al actualizar resultados
  function narrateResults(text) { if (narratorOn) speak(text); }

  // MOCK de 10 registros variados
  const MOCK = [
    {"Comunidad Aut√≥noma":"Andaluc√≠a","Nombre":"Juan P√©rez","Fecha de nacimiento":"1985-03-12","Sexo":"M","CCAA Residencia":"Andaluc√≠a","Fecha de Ingreso":"2025-01-10","Circunstancia de Contacto":"Urgencias","Fecha de Fin Contacto":"2025-01-15","Tipo Alta":"Domicilio","Estancia D√≠as":5,"Diagn√≥stico Principal":"J18 Neumon√≠a","Categor√≠a":"Respiratorio","Servicio":"Neumolog√≠a","Edad":40,"Reingreso":"No","Hospital":"Hospital Regional","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Madrid","Nombre":"Mar√≠a L√≥pez","Fecha de nacimiento":"1990-07-22","Sexo":"F","CCAA Residencia":"Madrid","Fecha de Ingreso":"2025-02-01","Circunstancia de Contacto":"Consulta programada","Fecha de Fin Contacto":"2025-02-03","Tipo Alta":"Traslado","Estancia D√≠as":2,"Diagn√≥stico Principal":"E11 Diabetes Mellitus","Categor√≠a":"Endocrino","Servicio":"Endocrinolog√≠a","Edad":35,"Reingreso":"S√≠","Hospital":"Hospital Cl√≠nico","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Catalu√±a","Nombre":"Luis Garc√≠a","Fecha de nacimiento":"1978-11-05","Sexo":"M","CCAA Residencia":"Catalu√±a","Fecha de Ingreso":"2025-03-12","Circunstancia de Contacto":"Hospitalizaci√≥n","Fecha de Fin Contacto":"2025-03-20","Tipo Alta":"Exitus","Estancia D√≠as":8,"Diagn√≥stico Principal":"I21 Infarto Agudo","Categor√≠a":"Cardiolog√≠a","Servicio":"Cardiolog√≠a","Edad":47,"Reingreso":"No","Hospital":"Hospital Comarcal","Ingreso en UCI":"S√≠","D√≠as UCI":3},
    {"Comunidad Aut√≥noma":"Valencia","Nombre":"Ana Torres","Fecha de nacimiento":"1988-09-15","Sexo":"F","CCAA Residencia":"Valencia","Fecha de Ingreso":"2025-04-05","Circunstancia de Contacto":"Urgencias","Fecha de Fin Contacto":"2025-04-10","Tipo Alta":"Domicilio","Estancia D√≠as":5,"Diagn√≥stico Principal":"F32 Depresi√≥n","Categor√≠a":"Psiquiatr√≠a","Servicio":"Salud Mental","Edad":36,"Reingreso":"No","Hospital":"Hospital General Valencia","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Galicia","Nombre":"Pedro Fern√°ndez","Fecha de nacimiento":"1975-06-20","Sexo":"M","CCAA Residencia":"Galicia","Fecha de Ingreso":"2025-05-01","Circunstancia de Contacto":"Hospitalizaci√≥n","Fecha de Fin Contacto":"2025-05-15","Tipo Alta":"Traslado","Estancia D√≠as":14,"Diagn√≥stico Principal":"C34 C√°ncer Pulm√≥n","Categor√≠a":"Oncolog√≠a","Servicio":"Oncolog√≠a","Edad":50,"Reingreso":"S√≠","Hospital":"CHUAC","Ingreso en UCI":"S√≠","D√≠as UCI":5},
    {"Comunidad Aut√≥noma":"Pa√≠s Vasco","Nombre":"Itziar Etxeberria","Fecha de nacimiento":"1995-11-30","Sexo":"F","CCAA Residencia":"Pa√≠s Vasco","Fecha de Ingreso":"2025-06-12","Circunstancia de Contacto":"Consulta programada","Fecha de Fin Contacto":"2025-06-14","Tipo Alta":"Domicilio","Estancia D√≠as":2,"Diagn√≥stico Principal":"G40 Epilepsia","Categor√≠a":"Neurolog√≠a","Servicio":"Neurolog√≠a","Edad":29,"Reingreso":"No","Hospital":"Hospital de Cruces","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Murcia","Nombre":"Carlos Mart√≠nez","Fecha de nacimiento":"1982-01-25","Sexo":"M","CCAA Residencia":"Murcia","Fecha de Ingreso":"2025-07-03","Circunstancia de Contacto":"Urgencias","Fecha de Fin Contacto":"2025-07-08","Tipo Alta":"Domicilio","Estancia D√≠as":5,"Diagn√≥stico Principal":"K35 Apendicitis","Categor√≠a":"Cirug√≠a","Servicio":"Cirug√≠a General","Edad":43,"Reingreso":"No","Hospital":"Hospital Virgen de la Arrixaca","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Castilla y Le√≥n","Nombre":"Laura G√≥mez","Fecha de nacimiento":"2000-12-10","Sexo":"F","CCAA Residencia":"Castilla y Le√≥n","Fecha de Ingreso":"2025-08-20","Circunstancia de Contacto":"Hospitalizaci√≥n","Fecha de Fin Contacto":"2025-08-25","Tipo Alta":"Domicilio","Estancia D√≠as":5,"Diagn√≥stico Principal":"N39 Infecci√≥n urinaria","Categor√≠a":"Nefrolog√≠a","Servicio":"Nefrolog√≠a","Edad":24,"Reingreso":"No","Hospital":"Hospital Cl√≠nico Valladolid","Ingreso en UCI":"No","D√≠as UCI":0},
    {"Comunidad Aut√≥noma":"Canarias","Nombre":"Diego Hern√°ndez","Fecha de nacimiento":"1969-04-18","Sexo":"M","CCAA Residencia":"Canarias","Fecha de Ingreso":"2025-09-01","Circunstancia de Contacto":"Urgencias","Fecha de Fin Contacto":"2025-09-10","Tipo Alta":"Exitus","Estancia D√≠as":9,"Diagn√≥stico Principal":"I63 Ictus","Categor√≠a":"Neurolog√≠a","Servicio":"Neurolog√≠a","Edad":56,"Reingreso":"S√≠","Hospital":"Hospital Universitario de Canarias","Ingreso en UCI":"S√≠","D√≠as UCI":4},
    {"Comunidad Aut√≥noma":"Arag√≥n","Nombre":"Sof√≠a Navarro","Fecha de nacimiento":"1993-02-14","Sexo":"F","CCAA Residencia":"Arag√≥n","Fecha de Ingreso":"2025-10-05","Circunstancia de Contacto":"Consulta programada","Fecha de Fin Contacto":"2025-10-07","Tipo Alta":"Domicilio","Estancia D√≠as":2,"Diagn√≥stico Principal":"M54 Lumbalgia","Categor√≠a":"Rehabilitaci√≥n","Servicio":"Rehabilitaci√≥n","Edad":32,"Reingreso":"No","Hospital":"Hospital Miguel Servet","Ingreso en UCI":"No","D√≠as UCI":0}
  ];

  // Refs
  const input = document.getElementById('q');
  const searchBtn = document.getElementById('searchBtn');
  const resetFiltersBtn = document.getElementById('resetFiltersBtn');
  const resultados = document.getElementById('resultados');
  const estadisticas = document.getElementById('estadisticas');
  const tablaDiv = document.getElementById('tabla');
  const grafica = document.getElementById('grafica');
  const resetBtn = document.getElementById('resetBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const filtroComunidad = document.getElementById('filtroComunidad');
  const filtroSexo = document.getElementById('filtroSexo');
  const filtroDiag = document.getElementById('filtroDiag');
  const filtroServicio = document.getElementById('filtroServicio');

  let chart;
  let lastRows = [];

  // Eventos
  searchBtn.addEventListener('click', handleQuery);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') handleQuery(); });
  resetFiltersBtn.addEventListener('click', clearFilters);
  resetBtn.addEventListener('click', clearAll);
  downloadBtn.addEventListener('click', downloadCSV);

  function clearFilters() {
    filtroComunidad.value = '';
    filtroSexo.value = '';
    filtroDiag.value = '';
    filtroServicio.value = '';
    input.value = '';
    resultados.classList.add('hidden');
    if (chart) chart.destroy();
    estadisticas.textContent = '';
    tablaDiv.innerHTML = '';
    narrateResults("Filtros limpiados. Puedes iniciar una nueva consulta.");
  }

  function clearAll() { clearFilters(); }

  // Utilidad: parsear lista por comas (OR)
  function parseCommaList(value) {
    return value
      .split(',')
      .map(v => v.trim())
      .filter(v => v.length > 0);
  }

  // L√≥gica de consulta con filtros multivalor por coma + b√∫squeda libre multivalor
  function handleQuery() {
    const q = input.value.trim().toLowerCase();
    let filtered = MOCK.slice();

    const comunidades = parseCommaList(filtroComunidad.value);
    const sexos = parseCommaList(filtroSexo.value);
    const diags = parseCommaList(filtroDiag.value);
    const servicios = parseCommaList(filtroServicio.value);

    if (comunidades.length) filtered = filtered.filter(r => comunidades.includes(r["Comunidad Aut√≥noma"]));
    if (sexos.length) filtered = filtered.filter(r => sexos.includes(r["Sexo"]));
    if (diags.length) filtered = filtered.filter(r => diags.includes(r["Diagn√≥stico Principal"]));
    if (servicios.length) filtered = filtered.filter(r => servicios.includes(r["Servicio"]));

    if (q) {
      const queries = parseCommaList(q);
      filtered = filtered.filter(item =>
        queries.some(query =>
          Object.values(item).some(val => String(val).toLowerCase().includes(query))
        )
      );
    }

    renderResults(filtered, q);
  }

  // Render de resultados: tabla + detalles completos + gr√°fico coherente
  function renderResults(rows, query) {
    resultados.classList.remove('hidden');
    lastRows = rows;

    if (!rows.length) {
      tablaDiv.innerHTML = `<p class="text-slate-700" role="alert">No hay resultados para: "${query}"</p>`;
      estadisticas.innerText = '';
      renderChart([]);
      narrateResults(`Sin resultados para la consulta: ${query}.`);
      return;
    }

    // Estad√≠sticas compactas
    const estancias = rows.map(r => Number(r["Estancia D√≠as"] || 0));
    const avgEstancia = estancias.length ? (estancias.reduce((a,b)=>a+b,0)/estancias.length).toFixed(2) : '‚Äî';
    const uciDays = rows.map(r => Number(r["D√≠as UCI"] || 0));
    const totalUci = uciDays.reduce((a,b)=>a+b,0);
    estadisticas.innerText = `Registros: ${rows.length} ¬∑ Estancia media: ${avgEstancia} d√≠as ¬∑ Total d√≠as UCI: ${totalUci}`;

    const cols = Object.keys(rows[0]); // columnas din√°micas

    const tableHeader = `
      <thead class="bg-sky-100">
        <tr>
          ${cols.map(c => `<th scope="col" class="p-2 text-left text-slate-700 whitespace-nowrap">${c}</th>`).join('')}
          <th scope="col" class="p-2 text-left text-slate-700">Detalle</th>
        </tr>
      </thead>
    `;

    const tableBody = `
      <tbody>
        ${rows.map((r, idx) => `
          <tr class="border-b hover:bg-sky-50">
            ${cols.map(c => `<td class="p-2 whitespace-nowrap">${safe(r[c])}</td>`).join('')}
            <td class="p-2">
              <button class="text-sky-700 underline focus-ring"
                      aria-expanded="false"
                      aria-controls="details-${idx}"
                      onclick="toggleDetails(${idx}, this)">
                Ver detalles
              </button>
            </td>
          </tr>
          <tr id="details-${idx}" class="hidden bg-slate-50">
            <td colspan="${cols.length + 1}" class="p-2">
              <div class="max-h-56 overflow-y-auto text-xs grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1" role="group" aria-label="Detalles del registro">
                ${renderAllFields(r)}
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    `;

    const table = `
      <table class="w-full border-collapse bg-white rounded shadow text-sm" role="table" aria-describedby="table-caption">
        <caption id="table-caption" class="sr-only">Tabla de resultados filtrados</caption>
        ${tableHeader}
        ${tableBody}
      </table>
    `;
    tablaDiv.innerHTML = table;

    renderChart(rows);
    narrateResults(`Se han encontrado ${rows.length} resultados.`);
  }

  function safe(v) { return (v === undefined || v === null || v === '') ? '‚Äî' : v; }

  // Mostrar TODOS los campos en detalles con pares etiqueta-valor
  function renderAllFields(row) {
    return Object.entries(row).map(([k, v]) =>
      `<p><span class="font-semibold text-slate-700">${k}:</span> <span class="text-slate-800">${safe(v)}</span></p>`
    ).join('');
  }

  function toggleDetails(idx, btn) {
    const row = document.getElementById(`details-${idx}`);
    const willShow = row.classList.contains('hidden');
    row.classList.toggle('hidden');
    btn.setAttribute('aria-expanded', String(willShow));
    btn.textContent = willShow ? 'Ocultar detalles' : 'Ver detalles';
    btn.focus();
  }

  // Gr√°fico coherente con datos filtrados: distribuci√≥n por Diagn√≥stico Principal
  function renderChart(data) {
    const counts = {};
    data.forEach(r => {
      const k = r["Diagn√≥stico Principal"] || 'Sin diagn√≥stico';
      counts[k] = (counts[k] || 0) + 1;
    });

    const ctx = grafica.getContext('2d');
    if (window.chartInstance) window.chartInstance.destroy();

    window.chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'Casos filtrados por diagn√≥stico principal',
          data: Object.values(counts),
          backgroundColor: 'rgba(56, 189, 248, 0.6)',  // sky-400
          borderColor: 'rgba(14, 165, 233, 1)',        // sky-500
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#e2e8f0' }, ticks: { color: '#334155' } },
          x: { grid: { display: false }, ticks: { color: '#334155' } }
        }
      }
    });
  }

  // Descargar CSV con TODOS los campos presentes en los datos filtrados
  function downloadCSV() {
    const rows = lastRows || [];
    if (!rows.length) return;

    const allKeys = Array.from(
      rows.reduce((set, row) => {
        Object.keys(row).forEach(k => set.add(k));
        return set;
      }, new Set())
    );

    const header = allKeys;
    const csvLines = [
      header.join(','),
      ...rows.map(r => header.map(k => {
        const val = String(r[k] ?? '');
        return `"${val.replace(/"/g, '""').replace(/,/g, ';')}"`;
      }).join(','))
    ];

    const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'resultados_filtrados.csv'; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
